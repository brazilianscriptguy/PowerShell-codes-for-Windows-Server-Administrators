# .github/workflows/SLSA-ProSuite-Publish.yml

name: SLSA-ProSuite-Publish

on:
  workflow_dispatch:
  release:
    types: [created]

permissions:
  contents: write
  id-token: write

jobs:
  build:
    runs-on: windows-latest
    outputs:
      digests: ${{ steps.hash.outputs.digests }}

    steps:
      # Step 1: Check out the repository
      - uses: actions/checkout@v4

      # Step 2: Build and package artifacts
      - name: Build and package artifacts
        run: |
          mkdir build
          # Copy scripts
          copy *.ps1 build || exit 0
          copy *.vbs build || exit 0
          # Copy documentation files
          copy README.md build || exit 0
          copy LICENSE build || exit 0

          # Create a zip file for release
          powershell Compress-Archive -Path build\* -DestinationPath Package-ProSuite.zip

      # Step 3: Generate provenance hashes
      - name: Generate provenance subjects
        id: hash
        run: |
          $files = Get-ChildItem -Path build\*
          $hashes = @()
          foreach ($file in $files) {
              $hash = (Get-FileHash $file.FullName -Algorithm SHA256).Hash
              $hashes += "$($file.FullName): $hash"
          }
          $digestOutput = [System.Convert]::ToBase64String([System.Text.Encoding]::UTF8.GetBytes($hashes -join "`n"))
          echo "digests=$digestOutput" >> $env:GITHUB_OUTPUT

      # Step 4: Upload artifact for provenance
      - name: Upload artifact for provenance
        uses: actions/upload-artifact@v3
        with:
          name: Package-ProSuite
          path: Package-ProSuite.zip

      # Optional: Debug logs
      - name: Debug artifacts
        run: |
          dir build
          dir Package-ProSuite.zip

  provenance:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      actions: read
      id-token: write
      contents: write
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_generic_slsa3.yml@v1.4.0
    with:
      base64-subjects: "${{ needs.build.outputs.digests }}"

  upload:
    needs: provenance
    runs-on: ubuntu-latest
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v3
        with:
          name: Package-ProSuite

      - name: Upload to release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./Package-ProSuite.zip
          asset_name: Package-ProSuite.zip
          asset_content_type: application/zip
