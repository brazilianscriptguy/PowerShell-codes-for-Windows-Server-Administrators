name: SLSA-ProSuite-Publish

on:
  workflow_dispatch:
  release:
    types: [created]

jobs:
  build:
    runs-on: windows-latest
    outputs:
      digests: ${{ steps.hash.outputs.digests }}

    steps:
      # Step 1: Check out the repository
      - uses: actions/checkout@v4

      # Step 2: Build and package artifacts
      - name: Build and package artifacts
        run: |
          mkdir build
          # Copy scripts
          copy *.ps1 build || exit 0
          copy *.vbs build || exit 0
          # Copy documentation files
          copy README.md build || exit 0
          copy LICENSE build || exit 0

          # Create a zip file for release
          powershell Compress-Archive -Path build\* -DestinationPath Package-ProSuite.zip

      # Step 3: Generate provenance hashes
      - name: Generate provenance subjects
        id: hash
        run: |
          $files = Get-ChildItem -Path build\*
          $hashes = @()
          foreach ($file in $files) {
              $hash = (Get-FileHash $file.FullName -Algorithm SHA256).Hash
              $hashes += "$($file.FullName): $hash"
          }
          $digestOutput = [System.Convert]::ToBase64String([System.Text.Encoding]::UTF8.GetBytes($hashes -join "`n"))
          echo "digests=$digestOutput" >> $env:GITHUB_ENV

      # Optional: Debug logs
      - name: Debug artifacts
        run: |
          dir build
          dir Package-ProSuite.zip

  provenance:
    needs: build
    runs-on: windows-latest
    permissions:
      actions: read
      id-token: write
      contents: write
    steps:
      - name: Use reusable workflow for provenance
        uses: slsa-framework/slsa-github-generator/.github/workflows/generator_generic_slsa3.yml@v1.4.0
        with:
          base64-subjects: "${{ needs.build.outputs.digests }}"
          upload-assets: true
          assets: Package-ProSuite.zip
