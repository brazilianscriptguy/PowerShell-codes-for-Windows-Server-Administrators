# .github/workflows/releases-sysadmin-ITSMs-Templates-GPOs-Templates.yml
name: Build and Release

on:
  workflow_dispatch:
  release:
    types: [published]
  schedule:
    - cron: '0 0 * * *'

permissions:
  contents: write

jobs:
  cleanup-old-releases:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Delete older releases
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh auth setup-git
          gh release list --json tagName,createdAt | jq -r '. | sort_by(.createdAt) | .[0:-1] | .[].tagName' | while read tag; do
            echo "Deleting old release: $tag"
            gh release delete "$tag" -y
          done

  build-and-release-SysAdminToolSet:
    needs: cleanup-old-releases
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          submodules: true
          fetch-depth: 0

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y zip jq gh

      - name: Handle Existing SysAdminToolSet Tag
        run: |
          if gh release view SysAdminToolSet > /dev/null 2>&1; then
            echo "Deleting existing release and tag for SysAdminToolSet."
            gh release delete SysAdminToolSet -y
          fi

      - name: Create New Release for SysAdminToolSet
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: SysAdminToolSet
          release_name: SysAdminToolSet.zip
          body: "Latest automated specialized release for SysAdminToolSet."
          draft: false
          prerelease: false

      - name: Build and package SysAdminToolSet
        run: |
          mkdir -p SysAdminToolSet
          cp LICENSE SysAdminToolSet/ || true
          cp README.md SysAdminToolSet/ || true
          cp Core-ScriptLibrary/Launch-Script-AutomaticMenu.ps1 SysAdminToolSet/ || true
          zip -r SysAdminToolSet.zip SysAdminToolSet
          echo "package_path=$(pwd)/SysAdminToolSet.zip" >> $GITHUB_ENV

      - name: Upload SysAdminToolSet Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create-release.outputs.upload_url }}
          asset_path: ${{ env.package_path }}
          asset_name: SysAdminToolSet.zip
          asset_content_type: application/zip

  build-and-release-itsm-templates-wks:
    needs: cleanup-old-releases
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          submodules: true
          fetch-depth: 0

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y zip jq gh

      - name: Handle Existing ITSM-Templates-WKS Tag
        run: |
          if gh release view ITSM-Templates-WKS > /dev/null 2>&1; then
            echo "Deleting existing release and tag for ITSM-Templates-WKS."
            gh release delete ITSM-Templates-WKS -y
          fi

      - name: Create New Release for ITSM-Templates-WKS
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ITSM-Templates-WKS
          release_name: ITSM-Templates-WKS.zip
          body: "Latest automated specialized release for ITSM-Templates-WKS."
          draft: false
          prerelease: false

      - name: Build and package ITSM-Templates-WKS
        run: |
          zip -r ITSM-Templates-WKS.zip ITSM-Templates-WKS
          echo "package_path=$(pwd)/ITSM-Templates-WKS.zip" >> $GITHUB_ENV

      - name: Upload ITSM-Templates-WKS Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create-release.outputs.upload_url }}
          asset_path: ${{ env.package_path }}
          asset_name: ITSM-Templates-WKS.zip
          asset_content_type: application/zip

  build-and-release-itsm-templates-svr:
    needs: cleanup-old-releases
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          submodules: true
          fetch-depth: 0

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y zip jq gh

      - name: Handle Existing ITSM-Templates-SVR Tag
        run: |
          if gh release view ITSM-Templates-SVR > /dev/null 2>&1; then
            echo "Deleting existing release and tag for ITSM-Templates-SVR."
            gh release delete ITSM-Templates-SVR -y
          fi

      - name: Create New Release for ITSM-Templates-SVR
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ITSM-Templates-SVR
          release_name: ITSM-Templates-SVR.zip
          body: "Latest automated specialized release for ITSM-Templates-SVR."
          draft: false
          prerelease: false

      - name: Build and package ITSM-Templates-SVR
        run: |
          zip -r ITSM-Templates-SVR.zip ITSM-Templates-SVR
          echo "package_path=$(pwd)/ITSM-Templates-SVR.zip" >> $GITHUB_ENV

      - name: Upload ITSM-Templates-SVR Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create-release.outputs.upload_url }}
          asset_path: ${{ env.package_path }}
          asset_name: ITSM-Templates-SVR.zip
          asset_content_type: application/zip

  build-and-release-GPOs-Templates:
    needs: cleanup-old-releases
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          submodules: true
          fetch-depth: 0

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y zip jq gh

      - name: Handle Existing GPOs-Templates Tag
        run: |
          if gh release view GPOs-Templates > /dev/null 2>&1; then
            echo "Deleting existing release and tag for GPOs-Templates."
            gh release delete GPOs-Templates -y
          fi

      - name: Create New Release for GPOs-Templates
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: GPOs-Templates
          release_name: GPOs-Templates.zip
          body: "Latest automated specialized release for GPOs-Templates."
          draft: false
          prerelease: false

      - name: Build and package GPOs-Templates
        run: |
          mkdir -p GPOs-Templates
          cp -r SysAdmin-Tools/GroupPolicyObjects-Templates/* GPOs-Templates/
          cp SysAdmin-Tools/ActiveDirectory-Management/Export-n-Import-GPOsTool.ps1 GPOs-Templates/
          zip -r GPOs-Templates.zip GPOs-Templates
          echo "package_path=$(pwd)/GPOs-Templates.zip" >> $GITHUB_ENV

      - name: Upload GPOs-Templates Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create-release.outputs.upload_url }}
          asset_path: ${{ env.package_path }}
          asset_name: GPOs-Templates.zip
          asset_content_type: application/zip
